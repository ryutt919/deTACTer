# 프로젝트 기획서: deTACTer (Tactical Analysis & Detection)

## 1. 프로젝트 개요
특정 팀의 세부 공격 전술 및 빌드업 패턴을 자동으로 탐지하고 가시화하여, 데이터 기반의 전술 분석 리포트를 제공합니다.

## 2. 주요 문제 정의
- **공격 세부 전술**: 팀의 VAEP(Valuing Actions by Estimating Probabilities) 수치가 특정 임계값(TH) 이상으로 상승하는 시퀀스 (수비 행동 제외).
    - TH : 시퀀스 전체의 누적 VAEP(Sum of VAEP)를 산출하여, 해당 팀 평균 대비 10~20% 이상의 시퀀스 식별.
- **시퀀스 정의**:
    - **유효 공격 시퀀스 (Effective Attack Sequence)**: **슈팅(Shot)**으로 마무리되거나, 최소한 **상대 패널티 박스(Penalty Box) 안으로 공을 투입**하는 데 성공한 시퀀스를 '유효 공격'으로 우선 규정함.
        - **박스 정의 (0-1 스케일 기준)**: $X > 0.84$ 이면서 $0.2 < Y < 1.0$ 영역 진입 기준.
        #fixed 현재 L->R로 공격 방향이 지정돼있어서 $X > 0.83$ 이면서 $0.2 < Y < 0.8$ 영역 진입 기준이 맞는지 확인 필요. -> **데이터 정합성 검증 완료**: 필드 규격 105x68m 확인. L->R 보정 시 $X > 88.5/105 \approx 0.84$가 실제 패널티 박스 경계와 일치함.
    - **공격 전술의 단위**: 위 유효 공격의 최종 단계 직전에 발생한 **유효한 이벤트들의 집합** (예: 박스 진입을 만든 결정적 패스, 공간 침투 드리블 등)을 해당 팀의 '핵심 공격 전술'로 정의함.
        - **직전에 발생한 유효한 이벤트들의 집합**:  (직접적 기회 창출 1~3회 + 공간 창출 및 전개 과정 4~7회 포괄)
        - #fixed 질문: 성과 직전 몇 개의 이벤트를 보는 것이 전술적으로 유의미한가? -> 데이터 분석 결과 직접적인 가치 상승은 평균 2.05개로 짧으나, '전술적 흐름(공간 창출 등)' 파악을 위해 7~10개 구간이 적절함을 확인하여 확정함.
    - **시점 (Start)**: 소유권 획득 시점 (`Interception`, `Recovery` 등)을 기점으로 하되, 최종 성과(슈팅/박스 진입)로부터 **역추적(Backtracking)**하여 전술적 기점을 식별함.
    - **빌드업 (Build-up)**: 유효 공격 전술로 식별된 이벤트 집합 이전의 후방 연결 과정.
    #fixed 여전히 문제점이 있음. 지공상황은 보통 상대방 진영에서 지속적으로 소유권을 유지하는 것임 -> 유효 공격 시퀀스 정의로 해결
    - **종료 (End)**: 슈팅, 소유권 전환, 혹은 경기 중단 (`Out`, `Pause` 등).


## 3. 핵심 기능

### Phase 1: 핵심 엔진 및 시각화
1. **전술 탐지 엔진**: 유사한 위치와 이벤트 시계열을 가진 시퀀스를 클러스터링.
2. **애니메이션 뷰어**: 탐지된 공격 및 빌드업 전술을 시각적인 애니메이션으로 제공.
3. **전술 선택 리스트**: "공격 전술 1, 2...", "빌드업 전술 1, 2..." 형태로 카테고리화하여 선택적 분석 지원.
4. #fixed 후순위, 최근 득점 시퀀스 보여주기 -> Phase 2 및 리포트 기능에 반영.

### Phase 2: 분석 고도화 (후순위)
1. **전술 자동 네이밍 (Auto-Naming)**: 클러스터링된 피처 특성을 추출하여 직관적인 명칭 부여 (예: "측면 빌드업 기반 크로스").
2. **성과 기반 스토리텔링**: 빌드업 단계의 누적 VAEP를 제시하여 득점 과정의 전술적 가치를 재조명.
3. **최근 득점 시퀀스 리포트**: 가장 최근 경기들의 득점 장면 시퀀스 집중 분석.

## 4. 데이터 전처리 및 피처 엔지니어링
### 4.0. 주요 전처리 항목 및 로직

### 4.0.1. 인코딩 및 문자열 정제
- **한글 깨짐 해결**: 모든 데이터 로드 및 저장 시 `encoding='utf-8-sig'`를 사용하여 선수명 및 팀명의 한글 데이터를 보존함.
- **불필요한 공백 제거**: `player_name_ko`, `team_name_ko` 등 문자열 필드의 앞뒤 공백 제거.

### 4.0.2. 좌표 정규화 및 보정 (Normalization)
- **공격 방향 통일 (L->R)**: 
    - **로직**: 각 세션(Period)별 골키퍼의 평균 위치를 분석하여 자팀 골대 위치를 판별.
    - **변환**: 만약 자팀 골대가 오른쪽(105m)에 있다면, 모든 액션의 $x$ 좌표를 $105 - x$로 반전시켜 항상 왼쪽에서 오른쪽으로 공격하도록 통일.
- **좌표 스케일링 (0~1)**:
    - **방법**: $x_{norm} = x / 105$, $y_{norm} = y / 68$
    - **이유**: DTW 및 클러스터링 알고리즘에서 X/Y축 간의 편향(Bias)을 제거하기 위함.

### 4.0.3. 유효 공격 시퀀스 추출 로직
- **성과 지표 기준**: `type_name`이 `shot`이거나, 종료 좌표($end_x, end_y$)가 패널티 박스($X > 0.84, 0.2 < Y < 0.8$) 내부인 경우를 '유효 공격'으로 식별.
- **역추적(Backtracking)**: 유효 공격 종료 시점으로부터 **역순으로 7~10개의 이벤트**를 하나의 시퀀스로 묶음.
- **빌드업 분리**: 역추적된 시퀀스 이전의 모든 소유 과정은 '빌드업 시퀀스'로 분류.

### 4.0.4. 이상치 처리 가이드
- **좌표 클리핑**: 필드 규격(0~105, 0~68)을 벗어나는 수치(약 수백 건 확인됨)는 경계값으로 클리핑 처리.
- **결측치 처리**: `player_id` 결측치(1건)는 분석 대상에서 제외 `result_name` 결측치는 그대로 사용

### 4.0.5. 향후 구현 반영 계획
- `scripts/convert_to_spadl.py`를 preprocessing.py로 통합. cover_to_spadl 내용을 함수로 사용

### 4.1. 데이터 정규화 (Normalization)
- **공격 방향 통일**: 모든 데이터를 왼쪽에서 오른쪽으로 공격하는 방향으로 보정.
    #fixed 좌우 섞여 있다고? 내가 이 데이터가 L->R로 처리돼있다고 했던거 같은데? -> **데이터 확인 결과**: `raw_data.csv` 분석 시 하나의 게임 내에서도 `start_x`가 0~105m 전 범위에 분포합니다. 즉, 전처리 전의 Raw 좌표 상태이므로, 분석의 일관성을 위해 한 방향(L->R)으로 통일하는 전처리 과정이 필수적임을 확인했습니다.
    #fixed 골키퍼위치를 기준으로 특정 팀이 공격할때 공격 방향을 항상 L->R 방향으로 통일 -> **로직 확정**: 각 기간(Period)별 골키퍼의 평균 위치를 추출하여 자팀 골대 위치(0m 또는 105m)를 판별하고, 모든 액션의 목표가 항상 상대 골대(105m)를 향하도록 좌표 반전(Mirroring) 처리를 수행함.
- **좌표 스케일링 (0~1)**: 
    - **알고리즘적 이득**: X(105)와 Y(68)의 스케일 차이로 인해 X축 거리가 거리에 더 큰 가중치를 갖는 '편향(Bias)'을 방지합니다. DTW 및 클러스터링 시 모든 축이 동일한 중요도로 계산됩니다.
    - **확장성**: 경기장마다 미세하게 다른 규격을 통일된 스케일로 다룰 수 있어 모델의 범용성을 확보합니다.
    - **복원**: 분석 로직 내에서는 0~1을 사용하고, 애니메이션 시각화 시에만 기존 스케일로 복원합니다.
    #fixed 지금 공격방향은 통일돼있고 필드 사이즈에 맞게 데이터가 입력돼있는데, 이 x,y 좌표를 0~1로 정규화하는것이 이득일까? -> 알고리즘 성능 향상을 위해 0-1 정규화 확정.

### 4.2. 피처 추출
- **템포 (Tempo)**: 액션 간 거리($dx, dy$)와 소요 시간($dt$)을 기반으로 공격의 속도감 측정.
- **패턴 정렬 (DTW)**: 동적 시간 워핑(Dynamic Time Warping)을 활용하여 액션의 순서와 위치를 동시에 고려한 경로 유사도 측정.
- **Y축 반전 처리 (Mirroring)**: 
    #fixed 왼쪽과 오른쪽 측면 공격의 패턴의 빈도나 선수배치가 다르니까 반전 처리를 안하는게 좋을 수도 있음 -> '전술적 비대칭성' 분석을 위해 옵션으로 남겨둠.

## 5. 로직 흐름
1. **분석 대상 설정**: 특정 팀 및 분석 기간 선택.
2. **시퀀스 추출 및 필터링**: VAEP 임계값 기반 유의미한 시퀀스 선별.
3. **유사도 분석 및 클러스터링**: DTW 거리를 기반으로 유사 전술 패턴 그룹화.
4. **전술 시각화**: 클러스터별 대표 시퀀스 및 통계 제공.